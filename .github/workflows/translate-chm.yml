name: CHM Translation Pipeline

on:
  push:
    paths:
      - 'input/*.chm'
  workflow_dispatch:
    inputs:
      chm_pattern:
        description: 'CHM文件匹配模式 (如: *.chm, help*.chm, *manual*.chm)'
        required: false
        default: '*.chm'
      chm_list:
        description: '或指定具体文件 (逗号分隔，如: help.chm,manual.chm)'
        required: false
        default: ''
      target_lang:
        description: '目标语言'
        required: true
        default: 'zh-CN'
      suffix_format:
        description: '后缀格式'
        required: true
        default: '-{lang}'

env:
  PYTHON_VERSION: '3.11'

jobs:
  find-and-process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install beautifulsoup4==4.12.0 lxml==4.9.0 chardet==5.1.0
          pip install requests==2.31.0 translate==3.6.1 tqdm==4.66.0
          pip install py7zr==0.20.0

      - name: Run batch translation with pattern
        if: inputs.chm_list == ''
        run: |
          echo "使用通配符模式: ${{ inputs.chm_pattern }}"
          python scripts/batch_process.py \
            --pattern "${{ inputs.chm_pattern }}" \
            --target-lang "${{ inputs.target_lang }}" \
            --suffix-format "${{ inputs.suffix_format }}" \
            --max-workers 2 \
            --log-level INFO

      - name: Run batch translation with list
        if: inputs.chm_list != ''
        run: |
          echo "使用文件列表: ${{ inputs.chm_list }}"
          python scripts/batch_process.py \
            --pattern "${{ inputs.chm_list }}" \
            --target-lang "${{ inputs.target_lang }}" \
            --suffix-format "${{ inputs.suffix_format }}" \
            --max-workers 2 \
            --log-level INFO

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: translated-chm-files
          path: |
            output/
            translated/
          retention-days: 7