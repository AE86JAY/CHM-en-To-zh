name: Translate CHM Files (Windows)

on:
  workflow_dispatch:
    inputs:
      file_pattern:
        description: 'CHMæ–‡ä»¶åŒ¹é…æ¨¡å¼ (ä¾‹å¦‚: *.chm æˆ– docs/*.chm)'
        required: true
        default: '**/*.chm'
      target_lang:
        description: 'ç›®æ ‡è¯­è¨€'
        required: true
        default: 'zh-CN'
      skip_commit:
        description: 'è·³è¿‡æäº¤åˆ°ä»“åº“'
        required: false
        default: 'false'
        type: boolean
  
  push:
    paths:
      - '**/*.chm'
    branches: [ main, master ]

jobs:
  translate-chm:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install beautifulsoup4 lxml html2text googletrans==4.0.0rc1
        pip install chm
        pip install chm-lib

    - name: Install 7-Zip
      run: |
        # ä¸‹è½½å¹¶å®‰è£…7-Zip
        $url = "https://www.7-zip.org/a/7z2301-x64.msi"
        $installer = "7z.msi"
        Invoke-WebRequest -Uri $url -OutFile $installer
        msiexec /i $installer /quiet /qn /norestart
        # æ·»åŠ 7-Zipåˆ°ç³»ç»Ÿè·¯å¾„
        $env:Path = "C:\Program Files\7-Zip;$env:Path"
        [Environment]::SetEnvironmentVariable("Path", $env:Path + ";C:\Program Files\7-Zip", "Machine")
        echo "7-Zipå®‰è£…å®Œæˆ"

    - name: Install HTML Help Workshop (hhc)
      run: |
        # ä¸‹è½½HTML Help Workshop
        $url = "https://download.microsoft.com/download/0/A/9/0A939EF6-E31C-430F-A3DF-DFAE7960D564/htmlhelp.exe"
        $installer = "htmlhelp.exe"
        if (!(Test-Path $installer)) {
          Invoke-WebRequest -Uri $url -OutFile $installer
        }
        
        # é™é»˜å®‰è£…
        if (Test-Path $installer) {
          Start-Process -FilePath $installer -ArgumentList "/Q" -Wait
          echo "HTML Help Workshopå®‰è£…å®Œæˆ"
        } else {
          echo "è­¦å‘Š: HTML Help Workshopä¸‹è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
        }
        
        # å°è¯•æŸ¥æ‰¾hhc.exeè·¯å¾„
        $hhcPaths = @(
          "C:\Program Files (x86)\HTML Help Workshop\hhc.exe",
          "C:\Program Files\HTML Help Workshop\hhc.exe"
        )
        
        foreach ($path in $hhcPaths) {
          if (Test-Path $path) {
            echo "æ‰¾åˆ°hhc.exe: $path"
            $env:Path = "$env:Path;$([System.IO.Path]::GetDirectoryName($path))"
            break
          }
        }

    - name: Install chmcmd (æ›¿ä»£å·¥å…·)
      run: |
        # ä¸‹è½½chmcmdä½œä¸ºå¤‡ç”¨å·¥å…·
        $chmcmdDir = "C:\chmcmd"
        if (!(Test-Path $chmcmdDir)) {
          New-Item -ItemType Directory -Force -Path $chmcmdDir
          $url = "https://github.com/dottedmag/chmox/releases/download/1.3/chmox-1.3.zip"
          $zip = "$chmcmdDir\chmox.zip"
          Invoke-WebRequest -Uri $url -OutFile $zip
          
          # è§£åŽ‹æ–‡ä»¶
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          [System.IO.Compression.ZipFile]::ExtractToDirectory($zip, $chmcmdDir)
          
          # æŸ¥æ‰¾chmcmd.exe
          $chmcmdExe = Get-ChildItem -Path $chmcmdDir -Recurse -Filter "chmcmd.exe" | Select-Object -First 1
          if ($chmcmdExe) {
            $chmcmdPath = $chmcmdExe.DirectoryName
            $env:Path = "$env:Path;$chmcmdPath"
            echo "chmcmdå®‰è£…å®Œæˆ: $chmcmdPath"
          }
        }

    - name: Setup environment variables
      run: |
        echo "TARGET_LANG=${{ github.event.inputs.target_lang || 'zh-CN' }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "FILE_PATTERN=${{ github.event.inputs.file_pattern || '**/*.chm' }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "SKIP_COMMIT=${{ github.event.inputs.skip_commit || 'false' }}" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Run CHM translation script
      run: |
        python scripts/translate_chm_windows.py "$env:FILE_PATTERN"
      shell: cmd

    - name: Upload translated files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: translated-chm-files
        path: |
          **/*_zh-cn.chm
          **/*_zh-cn/*.chm
        retention-days: 30
        if-no-files-found: warn
        compression-level: 9

    - name: List translated files
      run: |
        echo "ç¿»è¯‘å®Œæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        dir **/*_zh-cn.chm /s /b
      shell: cmd

    - name: Commit and push translated files
      if: env.SKIP_COMMIT == 'false'
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # æ·»åŠ æ‰€æœ‰ç¿»è¯‘åŽçš„CHMæ–‡ä»¶
        git add **/*_zh-cn.chm
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
        git status --porcelain | findstr "_zh-cn.chm"
        if %errorlevel% equ 0 (
          git commit -m "ðŸŒ æ·»åŠ ç¿»è¯‘åŽçš„CHMæ–‡ä»¶ [skip ci]"
          git push
          echo "å·²æäº¤ç¿»è¯‘æ–‡ä»¶åˆ°ä»“åº“"
        ) else (
          echo "æ²¡æœ‰æ–°çš„ç¿»è¯‘æ–‡ä»¶éœ€è¦æäº¤"
        )
      shell: cmd

    - name: Create summary report
      run: |
        echo "# CHMæ–‡ä»¶ç¿»è¯‘æŠ¥å‘Š" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "## ç¿»è¯‘è¯¦æƒ…" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "- **ç¿»è¯‘æ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $env:GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡è¯­è¨€**: ${{ env.TARGET_LANG }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **æ–‡ä»¶æ¨¡å¼**: ${{ env.FILE_PATTERN }}" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        
        # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
        $count = (Get-ChildItem -Path . -Recurse -Filter "*_zh-cn.chm" | Measure-Object).Count
        echo "- **ç¿»è¯‘æ–‡ä»¶æ•°**: $count" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        
        # åˆ—å‡ºæ–‡ä»¶
        if ($count -gt 0) {
          echo "## ç¿»è¯‘å®Œæˆçš„æ–‡ä»¶" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          Get-ChildItem -Path . -Recurse -Filter "*_zh-cn.chm" | ForEach-Object {
            $relPath = [System.IO.Path]::GetRelativePath($pwd, $_.FullName)
            echo "- $relPath" >> $env:GITHUB_STEP_SUMMARY
          }
        } else {
          echo "## æœªæ‰¾åˆ°ç¿»è¯‘æ–‡ä»¶" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "æœªç”Ÿæˆä»»ä½•ç¿»è¯‘æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œæ—¥å¿—ã€‚" >> $env:GITHUB_STEP_SUMMARY
        }
      shell: pwsh